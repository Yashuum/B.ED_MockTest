<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NishuAbhyasi – Teaching Principles by Yash</title>
    <style>
        :root{
            --color-primary: #1a2a6c;
            --color-secondary: #2575fc;
            --color-accent: #f2994a;
            --glass: rgba(255, 255, 255, 0.12);
            --glass-border: rgba(255, 255, 255, 0.25);
            --success: #16a34a;
            --danger: #ef4444;
            --review: #8b5cf6;
            --challenge: #f59e0b;
        }
        *{box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI', Tahoma, sans-serif;}
        body{
            min-height:100vh;
            background: linear-gradient(-45deg, var(--color-primary), var(--color-secondary), var(--color-primary), var(--color-accent));
            background-size: 300% 300%;
            animation: dynamicFlow 18s ease-in-out infinite;
            color: #fff;
            padding: 20px 10px;
        }
        @keyframes dynamicFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
        
        .container{ max-width:900px; margin:auto; position: relative; z-index: 2; }
        h1{ text-align:center; margin-bottom:10px; font-weight: 800; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        .start-screen{ background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); padding: 40px 20px; border-radius: 30px; text-align:center; margin-top: 50px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .input-row { display: flex; gap: 15px; width: 100%; max-width: 600px; justify-content: center; }
        .start-screen input, .start-screen select { 
            width: 100%; padding: 15px; border-radius: 15px; border: 1px solid var(--glass-border); 
            background: rgba(255, 255, 255, 0.15); color: #fff; font-size: 16px; outline: none; 
        }
        .start-screen input::placeholder { color: white !important; opacity: 1; }
        .start-screen option { color: #000; }
        
        .q-count-sticker { background: rgba(255, 255, 255, 0.1); padding: 8px 20px; border-radius: 50px; border: 1px solid var(--glass-border); font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .pulse-dot { width: 8px; height: 8px; background: #4facfe; border-radius: 50%; animation: pulse 1.5s infinite; }
        
        button{ padding: 14px 28px; border: none; border-radius: 15px; background: linear-gradient(135deg, #ff9800, #ff5722); color: #fff; cursor: pointer; font-weight: 700; transition: 0.3s; }
        button:hover:not(:disabled){ transform: scale(1.05); }
        button:disabled{ opacity: 0.5; cursor: not-allowed; }

        .btn-secondary { background: rgba(255,255,255,0.15); }
        .btn-review { background: var(--review); }
        .btn-challenge { background: var(--challenge); }
        .btn-clear { background: transparent; border: 1px solid #fff; padding: 6px 12px; font-size: 12px; margin-top: 10px; border-radius: 8px; cursor: pointer; color: #fff; }

        .top-bar{ display:none; justify-content:space-between; align-items:center; padding:15px 25px; background: var(--glass); backdrop-filter: blur(15px); border:1px solid var(--glass-border); border-radius:50px; position:sticky; top:10px; z-index:100; margin-bottom:15px; }
        .timer{ font-weight:800; color:#fff; background: var(--danger); padding: 5px 15px; border-radius: 20px; }
        
        #palette{ display:none; flex-wrap:wrap; gap:8px; margin-bottom:20px; justify-content: center; padding: 10px; }
        .palette span{ width:38px; height:38px; display:flex; align-items:center; justify-content:center; border-radius:10px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); cursor:pointer; font-size: 13px; }
        .palette .visited{ border: 2px solid var(--color-secondary); }
        .palette .attempted{ background: var(--success); box-shadow: 0 0 8px var(--success); }
        .palette .marked-review{ background: var(--review); }
        .palette .challenged{ background: var(--challenge); }

        .quiz-card{ background: var(--glass); border:1px solid var(--glass-border); backdrop-filter: blur(20px); border-radius:25px; padding:30px; }
        .options label{ display:flex; align-items: center; gap:12px; padding:14px; background: rgba(255,255,255,0.05); border:1px solid var(--glass-border); border-radius:15px; margin:10px 0; cursor:pointer; transition: 0.2s; }
        .options label:hover{ background: rgba(255,255,255,0.15); transform: translateX(5px); }
        
        .nav{ display:none; justify-content:space-between; margin-top:20px; flex-wrap: wrap; gap: 10px; }
        .result{ background: var(--glass); padding: 25px; border-radius: 25px; margin-top:20px; }
        .correct{ color: #4ade80; font-weight:bold; }
        .wrong{ color: #f87171; font-weight:bold; }
        .sol-box { margin-top:12px; padding:12px; background:rgba(242, 153, 74, 0.15); border-radius:12px; font-size:14px; color:#ffcc80; border: 1px dashed var(--color-accent); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script> (function () { emailjs.init("L8kGW-X7JOiYaycH5"); })(); </script>
</head>
<body>
<div class="container">
    <h1>Target Test- Teaching Principles 2026</h1>
    <p style="text-align:center; opacity:0.8; font-size:13px; margin-bottom:20px; color:#fff;">Questions Set: <span id="lastUpdated">Syncing...</span></p>
    
    <div class="start-screen" id="startScreen">
        <div class="input-row">
            <input id="candidateName" placeholder="Enter your name">
            <input id="testTime" type="number" placeholder="Minutes">
        </div>
        <select id="difficultyLevel" style="max-width: 600px;" onchange="handleLevelSwitch()">
            <option value="easy">Level: Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
        </select>
        <div class="q-count-sticker">
            <span class="pulse-dot"></span>
            <span>Questions Loaded: <b id="totalQDisplay">0</b></span>
        </div>
        <div style="display:flex; gap:10px;">
            <button id="mainStartBtn" onclick="startTest()">Start Test</button>
            <button type="button" class="btn-secondary" onclick="window.location.href='https://yashuum.github.io/B.ED_MockTest/'">Go Back</button>
        </div>
    </div>

    <div class="top-bar" id="topBar">
        <div><small style="opacity:0.9;">CANDIDATE:</small><br><b id="displayName"></b></div>
        <div class="timer" id="timer">00:00</div>
    </div>

    <div id="palette" class="palette"></div>
    <div id="quizArea"></div>

    <div class="nav" id="navBtns">
        <button class="btn-secondary" onclick="prevQ()" id="prevBtn">← Prev</button>
        <button class="btn-review" onclick="markForReview()">Review</button>
        <button class="btn-challenge" onclick="challengeQuestion()">Challenge</button>
        <div style="display:flex; flex-direction:column; align-items:center;">
            <button onclick="nextQ()" id="nextBtn">Next →</button>
            <span id="lastQMsg" style="font-size:10px; color:var(--color-accent); margin-top:5px; display:none;">Last question, submit test now</span>
        </div>
    </div>

    <button id="submitBtn" style="display:none; margin: 30px auto 0; width: 100%;" onclick="submitQuiz()">Submit Test Now</button>
    <div id="result" class="result" style="display:none"></div>
    <button id="clearBtn" class="btn-secondary" style="display:none; width:100%; margin-top:20px; background:var(--danger);" onclick="clearResult()">Clear Result & Restart</button>
</div>

<script>
    const MY_SUBJECT = "Teaching";
    const GIST_API_URL = "https://api.github.com/gists/ecc0225df38396f70445c4dd702ff939";

    let allQuestionsBank = null;
    let questions = [];
    let currentIndex=0, answers={}, visited={}, reviewMarks={}, challenges={};
    let totalSeconds=0, timerInterval, startTime;

    async function loadData() {
        try {
            const response = await fetch(GIST_API_URL);
            const data = await response.json();
            const fileName = Object.keys(data.files)[0];
            allQuestionsBank = JSON.parse(data.files[fileName].content);
            
            syncCountAndTime();
            document.getElementById('lastUpdated').innerText = new Date(data.updated_at).toLocaleString('en-IN');

            handleLevelSwitch(); // Sync UI with selection on load
        } catch (e) { console.error("Load failed", e); }
    }

    // Fix 1: Independent Level Re-attempt Fix
    function handleLevelSwitch() {
        if(!allQuestionsBank) return;
        const level = document.getElementById("difficultyLevel").value;
        const count = allQuestionsBank[level].length;
        document.getElementById("totalQDisplay").textContent = count;
        document.getElementById("testTime").value = count;

        result.style.display = "none";
        clearBtn.style.display = "none";
        startScreen.style.display = "flex";
        quizArea.innerHTML = "";
        palette.style.display = "none";
        navBtns.style.display = "none";
        submitBtn.style.display = "none";
        topBar.style.display = "none";

        const savedReport = localStorage.getItem(`finalResult_${MY_SUBJECT}_${level}`);
        if(savedReport) {
            showFinalReport(level);
        } else if(localStorage.getItem(`inProgress_${MY_SUBJECT}_${level}`)) {
            const p = JSON.parse(localStorage.getItem(`inProgress_${MY_SUBJECT}_${level}`));
            candidateName.value = p.name || "";
            testTime.value = Math.ceil(p.totalSeconds / 60);
        }
    }

    function syncCountAndTime() {
        if(!allQuestionsBank) return;
        const level = document.getElementById("difficultyLevel").value;
        const count = allQuestionsBank[level].length;
        document.getElementById("totalQDisplay").textContent = count;
        document.getElementById("testTime").value = count;
    }

    function startTest(){
        if(!allQuestionsBank) return;
        const level = document.getElementById("difficultyLevel").value;
        questions = allQuestionsBank[level];
        if(!candidateName.value || !testTime.value) { alert("Enter Name/Time"); return; }

        displayName.textContent = candidateName.value + ` (${level.toUpperCase()})`;
        startScreen.style.display="none";
        topBar.style.display="flex";
        palette.style.display="flex";
        navBtns.style.display="flex";
        submitBtn.style.display="block";

        const progress = localStorage.getItem(`inProgress_${MY_SUBJECT}_${level}`);
        if(progress) {
            const p = JSON.parse(progress);
            answers=p.answers || {}; visited=p.visited || {}; currentIndex=p.currentIndex || 0; 
            totalSeconds=p.totalSeconds; startTime=p.startTime; 
            reviewMarks=p.reviewMarks || {}; challenges=p.challenges || {};
        } else {
            answers={}; visited={}; currentIndex=0; reviewMarks={}; challenges={};
            totalSeconds=testTime.value*60; startTime=Date.now();
        }
        startTimer();
        renderQuestion();
    }

    function startTimer(){
        if(timerInterval) clearInterval(timerInterval);
        timerInterval=setInterval(()=>{
            totalSeconds--;
            updateTimerDisplay();
            saveProgress();
            if(totalSeconds<=0) submitQuiz();
        },1000);
    }

    function updateTimerDisplay(){
        timer.textContent= String(Math.floor(totalSeconds/60)).padStart(2,'0')+":"+ String(totalSeconds%60).padStart(2,'0');
    }

    function renderQuestion(){
        visited[currentIndex]=true;
        const q=questions[currentIndex];
        quizArea.innerHTML=`<div class="quiz-card">
            <div style="display:flex; justify-content:space-between; align-items:start;">
                <b style="display:block; margin-bottom:15px; font-size:1.1em;">Q${currentIndex+1}. ${q.q}</b>
                ${challenges[currentIndex] ? '<span style="color:var(--challenge); font-weight:bold;">[CHALLENGED]</span>' : ''}
            </div>
            <div class="options">
                ${q.options.map(o=>`<label><input type="radio" name="opt" ${answers[currentIndex]==o?'checked':''} onchange="selectAnswer('${o}')"> ${o}</label>`).join("")}
            </div>
            ${answers[currentIndex] ? `<button class="btn-clear" onclick="clearSelection()">Clear Selection</button>` : ''}
        </div>`;
        document.getElementById("nextBtn").disabled = (currentIndex === questions.length - 1);
        document.getElementById("prevBtn").disabled = (currentIndex === 0);
        document.getElementById("lastQMsg").style.display = (currentIndex === questions.length - 1) ? "block" : "none";
        renderPalette();
    }

    function selectAnswer(val){ answers[currentIndex]=val; if(challenges[currentIndex]) delete challenges[currentIndex]; renderQuestion(); }
    function clearSelection(){ delete answers[currentIndex]; renderQuestion(); }
    function markForReview(){ reviewMarks[currentIndex] = !reviewMarks[currentIndex]; renderPalette(); }
    function challengeQuestion(){ if(!answers[currentIndex] && confirm("Challenge?")) { challenges[currentIndex] = true; renderPalette(); } }

    function renderPalette(){
        palette.innerHTML="";
        questions.forEach((_,i)=>{
            const s=document.createElement("span"); s.textContent=i+1;
            if(visited[i]) s.classList.add("visited");
            if(answers[i]) s.classList.add("attempted");
            if(reviewMarks[i]) s.classList.add("marked-review");
            if(challenges[i]) s.classList.add("challenged");
            s.onclick=()=>{currentIndex=i;renderQuestion()};
            palette.appendChild(s);
        });
    }

    function nextQ(){if(currentIndex<questions.length-1){currentIndex++;renderQuestion();}}
    function prevQ(){if(currentIndex>0){currentIndex--;renderQuestion();}}

    function saveProgress(){
        const level = document.getElementById("difficultyLevel").value;
        localStorage.setItem(`inProgress_${MY_SUBJECT}_${level}`,JSON.stringify({
            name:candidateName.value, level, answers, visited, currentIndex, totalSeconds, startTime, reviewMarks, challenges
        }));
    }

    function submitQuiz(){
        if(!confirm("Submit Test?")) return;
        clearInterval(timerInterval);
        const level = document.getElementById("difficultyLevel").value;
        localStorage.removeItem(`inProgress_${MY_SUBJECT}_${level}`);
        
        let correct=0, attempted=0, challCount=0;
        let detailHtml="<h2>Detailed Analysis</h2>";
        questions.forEach((q,i)=>{
            let isCorrect = false;
            let userAns = answers[i] || (challenges[i] ? "CHALLENGED" : "Skipped");
            if(challenges[i] && !answers[i]) { isCorrect = true; challCount++; }
            else if(answers[i] === q.answer) { isCorrect = true; }
            if(answers[i]) attempted++; if(isCorrect) correct++;
            detailHtml+=`<div style="margin:10px 0; padding:15px; background:rgba(255,255,255,0.05); border-radius:15px; border-left:5px solid ${isCorrect?'#4ade80':'#f87171'}">
                <p><b>Q${i+1}.</b> ${q.q}</p><p>Your Ans: <span class="${isCorrect?'correct':'wrong'}">${userAns}</span> | Correct: <b style="color:#4ade80;">${q.answer}</b></p>
                <div class="sol-box"><b>Logic:</b> ${q.solution}</div></div>`;
        });

        // Fix 2: Key for Dashboard Labels & Accuracy Sync
        const currentLvl = level.toUpperCase();
        const now = new Date().toISOString(); 
        localStorage.setItem(`score_${MY_SUBJECT}_${currentLvl}`, `${correct}/${questions.length}`);
        localStorage.setItem(`score_date_${MY_SUBJECT}_${currentLvl}`, now); 
        localStorage.setItem(`done_${MY_SUBJECT}_${currentLvl}`, "true");

        const timeTaken = Math.floor((Date.now() - startTime) / 1000);
        const accuracy = attempted ? Math.round(((correct - challCount) / attempted) * 100) : 0;
        
        const summary = `<div style="text-align:center; padding:25px; background:rgba(255,255,255,0.15); border-radius:20px; margin-bottom:25px; border:1px solid var(--glass-border);">
            <h3 style="color:var(--color-accent);">${MY_SUBJECT.replace('_',' ')} Performance Report</h3>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; font-size:14px; margin-top:15px;">
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">Score: <br><b>${correct} / ${questions.length}</b></div>
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">Accuracy: <br><b>${accuracy}%</b></div>
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">Time: <br><b>${Math.floor(timeTaken/60)}m ${timeTaken%60}s</b></div>
                <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">Attempted: <br><b>${attempted}</b></div>
            </div>
            <button onclick="window.location.href='https://yashuum.github.io/B.ED_MockTest/'" style="margin-top:20px; width:100%; background:var(--success);">Dashboard</button></div>`;

        const finalHtml = summary + detailHtml;
        localStorage.setItem(`finalResult_${MY_SUBJECT}_${level}`, JSON.stringify({ name: displayName.textContent, html: finalHtml }));
        
        result.style.display="block"; result.innerHTML = finalHtml;
        quizArea.innerHTML=""; palette.style.display="none"; navBtns.style.display="none"; submitBtn.style.display="none";
        startScreen.style.display="none"; topBar.style.display="none"; clearBtn.style.display="block";
        window.scrollTo(0,0);
        
        emailjs.send("service_wq5yoyp", "template_doegpcp", { 
            candidate_name: displayName.textContent, subject: MY_SUBJECT.replace('_',' '), score: correct, total: questions.length, 
            accuracy: accuracy + "%", time_taken: `${Math.floor(timeTaken/60)}m ${timeTaken%60}s` 
        });
    }

    function showFinalReport(level) {
        const data = JSON.parse(localStorage.getItem(`finalResult_${MY_SUBJECT}_${level}`));
        if(data) {
            result.style.display="block"; result.innerHTML = data.html;
            startScreen.style.display="none"; palette.style.display="none"; 
            navBtns.style.display="none"; submitBtn.style.display="none"; clearBtn.style.display="block";
        }
    }

    window.onload = loadData;

    function clearResult(){ 
        const level = document.getElementById("difficultyLevel").value;
        if(confirm("Clear this result?")) {
            localStorage.removeItem(`finalResult_${MY_SUBJECT}_${level}`);
            localStorage.removeItem(`inProgress_${MY_SUBJECT}_${level}`);
            localStorage.removeItem(`score_${MY_SUBJECT}_${level.toUpperCase()}`);
            localStorage.removeItem(`score_date_${MY_SUBJECT}_${level.toUpperCase()}`);
            localStorage.removeItem(`done_${MY_SUBJECT}_${level.toUpperCase()}`);
            location.reload(); 
        }
    }
</script>
</body>
</html>
