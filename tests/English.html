<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NishuAbhyasi – English by Yash</title>
    <style>
        :root{
            --color-primary: #1a2a6c;
            --color-secondary: #2575fc;
            --color-accent: #f2994a;
            --glass: rgba(255, 255, 255, 0.12);
            --glass-border: rgba(255, 255, 255, 0.25);
            --success: #16a34a;
            --danger: #ef4444;
            --review: #8b5cf6;
            --challenge: #f59e0b;
        }
        *{box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI', Tahoma, sans-serif;}
        body{
            min-height:100vh;
            background: linear-gradient(-45deg, var(--color-primary), var(--color-secondary), var(--color-primary), var(--color-accent));
            background-size: 300% 300%;
            animation: dynamicFlow 18s ease-in-out infinite;
            color: #fff;
            padding: 20px 10px;
        }
        @keyframes dynamicFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
        
        .container{ max-width:900px; margin:auto; position: relative; z-index: 2; }
        h1{ text-align:center; margin-bottom:10px; font-weight: 800; text-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        .start-screen{ background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); padding: 40px 20px; border-radius: 30px; text-align:center; margin-top: 50px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .input-row { display: flex; gap: 15px; width: 100%; max-width: 600px; justify-content: center; }
        .start-screen input, .start-screen select { 
            width: 100%; padding: 15px; border-radius: 15px; border: 1px solid var(--glass-border); 
            background: rgba(255, 255, 255, 0.15); color: #fff; font-size: 16px; outline: none; 
        }
		.start-screen input::placeholder { color: white !important; opacity: 1; }
        .start-screen option { color: #000; }
        
        .q-count-sticker { background: rgba(255, 255, 255, 0.1); padding: 8px 20px; border-radius: 50px; border: 1px solid var(--glass-border); font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .pulse-dot { width: 8px; height: 8px; background: #4facfe; border-radius: 50%; animation: pulse 1.5s infinite; }
        
        button{ padding: 14px 28px; border: none; border-radius: 15px; background: linear-gradient(135deg, #ff9800, #ff5722); color: #fff; cursor: pointer; font-weight: 700; transition: 0.3s; }
        button:hover:not(:disabled){ transform: scale(1.05); }
        button:disabled{ opacity: 0.5; cursor: not-allowed; }
        
        .btn-secondary { background: rgba(255,255,255,0.15); }
        .btn-review { background: var(--review); }
        .btn-challenge { background: var(--challenge); }
        .btn-clear { background: transparent; border: 1px solid #fff; padding: 6px 12px; font-size: 12px; margin-top: 10px; border-radius: 8px; cursor: pointer; color: #fff; }

        .top-bar{ display:none; justify-content:space-between; align-items:center; padding:15px 25px; background: var(--glass); backdrop-filter: blur(15px); border:1px solid var(--glass-border); border-radius:50px; position:sticky; top:10px; z-index:100; margin-bottom:15px; }
        .timer{ font-weight:800; color:#fff; background: var(--danger); padding: 5px 15px; border-radius: 20px; }
        
        #palette{ display:none; flex-wrap:wrap; gap:8px; margin-bottom:20px; justify-content: center; padding: 10px; }
        .palette span{ width:38px; height:38px; display:flex; align-items:center; justify-content:center; border-radius:10px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); cursor:pointer; font-size: 13px; }
        .palette .visited{ border: 2px solid var(--color-secondary); }
        .palette .attempted{ background: var(--success); box-shadow: 0 0 8px var(--success); }
        .palette .marked-review{ background: var(--review); }
        .palette .challenged{ background: var(--challenge); }

        .quiz-card{ background: var(--glass); border:1px solid var(--glass-border); backdrop-filter: blur(20px); border-radius:25px; padding:30px; }
        .options label{ display:flex; align-items: center; gap:12px; padding:14px; background: rgba(255,255,255,0.05); border:1px solid var(--glass-border); border-radius:15px; margin:10px 0; cursor:pointer; transition: 0.2s; }
        .options label:hover{ background: rgba(255,255,255,0.15); transform: translateX(5px); }
        
        .nav{ display:none; justify-content:space-between; margin-top:20px; flex-wrap: wrap; gap: 10px; }
        .result{ background: var(--glass); padding: 25px; border-radius: 25px; margin-top:20px; }
        .correct{ color: #4ade80; font-weight:bold; }
        .wrong{ color: #f87171; font-weight:bold; }
        .sol-box { margin-top:12px; padding:12px; background:rgba(242, 153, 74, 0.15); border-radius:12px; font-size:14px; color:#ffcc80; border: 1px dashed var(--color-accent); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script> (function () { emailjs.init("L8kGW-X7JOiYaycH5"); })(); </script>
</head>
<body>
<div class="container">
    <h1>Target Test- English 2026</h1>
    <p style="text-align:center; opacity:0.8; font-size:13px; margin-bottom:20px; color:#fff;">Last Updated: 22 Jan, 2026 - 08:51 PM</p>
    
    <div class="start-screen" id="startScreen">
        <div class="input-row">
            <input id="candidateName" placeholder="Enter your name">
            <input id="testTime" type="number" placeholder="Minutes">
        </div>
        
        <select id="difficultyLevel" style="max-width: 600px;" onchange="syncCountAndTime()">
            <option value="easy">Level: Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
        </select>

        <div class="q-count-sticker">
            <span class="pulse-dot"></span>
            <span>Questions Loaded: <b id="totalQDisplay">0</b></span>
        </div>

        <div style="display:flex; gap:10px;">
            <button onclick="startTest()">Start Test</button>
            <button type="button" class="btn-secondary" onclick="window.location.href='https://yashuum.github.io/B.ED_MockTest/'">Go Back</button>
        </div>
    </div>

    <div class="top-bar" id="topBar">
        <div><small style="opacity:0.9;">CANDIDATE:</small><br><b id="displayName"></b></div>
        <div class="timer" id="timer">00:00</div>
    </div>

    <div id="palette" class="palette"></div>
    <div id="quizArea"></div>

    <div class="nav" id="navBtns">
        <button class="btn-secondary" onclick="prevQ()" id="prevBtn">← Prev</button>
        <button class="btn-review" onclick="markForReview()">Review</button>
        <button class="btn-challenge" onclick="challengeQuestion()">Challenge</button>
        <div style="display:flex; flex-direction:column; align-items:center;">
            <button onclick="nextQ()" id="nextBtn">Next →</button>
            <span id="lastQMsg" style="font-size:10px; color:var(--color-accent); margin-top:5px; display:none;">Last question, submit test now</span>
        </div>
    </div>

    <button id="submitBtn" style="display:none; margin: 30px auto 0; width: 100%;" onclick="submitQuiz()">Submit Test Now</button>
    <div id="result" class="result" style="display:none"></div>
    <button id="clearBtn" class="btn-secondary" style="display:none; width:100%; margin-top:20px; background:var(--danger);" onclick="clearResult()">Clear Result & Restart</button>
</div>

<script>
    const MY_SUBJECT = "English";
    const MY_TEST_ID = "ENG_SET_07";

    const allQuestionsBank = {
easy: [

  {q: "Choose the correct Article: 'He is ___ honest man.'", options: ["a", "an", "the", "no article"], answer: "an", solution: "'Honest' starts with a silent 'H' and a vowel sound 'O', so we use 'an'."},
  {q: "Select the Synonym of 'HAPPY':", options: ["Sad", "Joyful", "Angry", "Brave"], answer: "Joyful", solution: "Joyful means the same as happy; the others are opposites or unrelated."},
  {q: "What is the plural of 'CHILD'?", options: ["Childs", "Childrens", "Children", "Childes"], answer: "Children", solution: "Child has an irregular plural form which is 'children'."},
  {q: "Choose the Antonym of 'FAST':", options: ["Quick", "Slow", "Swift", "Rapid"], answer: "Slow", solution: "Slow is the opposite of fast."},
  {q: "Identify the Noun in the sentence: 'Ram is playing football.'", options: ["Ram", "Playing", "Is", "Fast"], answer: "Ram", solution: "Ram is the name of a person, hence it is a Noun."},
  {q: "Fill in the blank: 'The cat is sitting ___ the table.'", options: ["in", "on", "between", "into"], answer: "on", solution: "'On' is used to show a position on a surface."},
  {q: "Choose the correctly spelt word:", options: ["Believe", "Beleive", "Belive", "Belleve"], answer: "Believe", solution: "The rule is 'i' before 'e' except after 'c'."},
  {q: "Fill in the blank: 'I ___ a student.'", options: ["is", "am", "are", "was"], answer: "am", solution: "With the pronoun 'I', we always use 'am' in the present tense."},
  {q: "What is the past tense of 'GO'?", options: ["Goed", "Gone", "Went", "Going"], answer: "Went", solution: "Go is an irregular verb (Go - Went - Gone)."},
  {q: "A person who teaches is called a:", options: ["Doctor", "Teacher", "Driver", "Farmer"], answer: "Teacher", solution: "A teacher is one who provides education."},
  {q: "Choose the correct Article: 'I saw ___ elephant in the zoo.'", options: ["a", "an", "the", "no article"], answer: "an", solution: "'Elephant' starts with a vowel sound (E)."},
  {q: "Find the odd one out:", options: ["Apple", "Mango", "Banana", "Potato"], answer: "Potato", solution: "Potato is a vegetable, others are fruits."},
  {q: "Which word is an Adjective?", options: ["Run", "Beautiful", "Quickly", "He"], answer: "Beautiful", solution: "Beautiful describes a noun, so it is an adjective."},
  {q: "Meaning of the idiom: 'Piece of cake'", options: ["Very difficult", "Very easy", "Something sweet", "A birthday party"], answer: "Very easy", solution: "'Piece of cake' means a task that is very simple to do."},
  {q: "Opposite of 'BEAUTIFUL' is:", options: ["Pretty", "Ugly", "Nice", "Clean"], answer: "Ugly", solution: "Ugly is the antonym of beautiful."},
  {q: "Fill in the blank: 'She ___ her work daily.'", options: ["do", "does", "doing", "done"], answer: "does", solution: "Third-person singular (She) takes 'does' in Simple Present tense."},
  {q: "One word substitution: 'A place where books are kept'", options: ["Gym", "Library", "Kitchen", "Park"], answer: "Library", solution: "A library is a collection of books for reading."},
  {q: "Identify the Verb: 'They sing a song.'", options: ["They", "Sing", "A", "Song"], answer: "Sing", solution: "'Sing' is an action word, which is a verb."},
  {q: "Correct the spelling:", options: ["Recieve", "Receive", "Receve", "Reseive"], answer: "Receive", solution: "In 'Receive', 'e' comes before 'i' because of the letter 'c'."},
  {q: "What is the feminine of 'KING'?", options: ["Woman", "Queen", "Girl", "Princess"], answer: "Queen", solution: "Queen is the female counterpart of a King."},
  {q: "Fill in: 'They ___ playing in the park.'", options: ["is", "am", "are", "has"], answer: "are", solution: "Plural subject (They) takes 'are' in the present continuous tense."},
  {q: "Antonym of 'RICH':", options: ["Poor", "Wealthy", "Kind", "Strong"], answer: "Poor", solution: "Poor is the opposite of rich."},
  {q: "Meaning of 'COLD':", options: ["Hot", "Chilly", "Sunny", "Warm"], answer: "Chilly", solution: "Chilly is a synonym for cold."},
  {q: "Choose the correct Preposition: 'The book is ___ the bag.'", options: ["in", "on", "to", "at"], answer: "in", solution: "We use 'in' to show something is inside a container or space."},
  {q: "A group of lions is called a:", options: ["Pack", "Herd", "Pride", "Flock"], answer: "Pride", solution: "Collective noun for lions is 'Pride'."},
  {q: "Synonym of 'FAST':", options: ["Slow", "Quick", "Lazy", "Quiet"], answer: "Quick", solution: "Quick and fast have similar meanings."},
  {q: "Identify the Pronoun: 'He is my friend.'", options: ["He", "Friend", "Is", "My"], answer: "He", solution: "'He' replaces a noun, so it is a pronoun."},
  {q: "Fill in: 'Sun rises in ___ East.'", options: ["a", "an", "the", "no article"], answer: "the", solution: "We use 'the' before unique things and directions (The Sun, The East)."},
  {q: "Plural of 'BUS' is:", options: ["Buses", "Buss", "Busess", "Bus"], answer: "Buses", solution: "Words ending in 's' take 'es' to become plural."},
  {q: "Meaning of 'Brave':", options: ["Coward", "Fearless", "Weak", "Tired"], answer: "Fearless", solution: "Brave means having no fear."}

 ],
medium: [

  {q: "Fill in the blank: 'Neither of the two candidates ___ suitable.'", options: ["are", "is", "were", "have"], answer: "is", solution: "'Neither' is always singular, so it takes a singular verb 'is'."},
  {q: "Choose the correct synonym of 'OBSTINATE':", options: ["Flexible", "Stubborn", "Gentle", "Helpful"], answer: "Stubborn", solution: "Obstinate means refusing to change one's opinion; stubborn."},
  {q: "Change to Passive Voice: 'The boy killed the snake.'", options: ["The snake was killed by the boy.", "The snake is killed by the boy.", "The snake had killed by the boy.", "A boy killed a snake."], answer: "The snake was killed by the boy.", solution: "Simple Past (V2) changes to 'was/were + V3' in passive voice."},
  {q: "Select the correctly spelt word:", options: ["Occurence", "Occurrence", "Ocurence", "Occurance"], answer: "Occurrence", solution: "The correct spelling has double 'c' and double 'r'."},
  {q: "Meaning of the idiom: 'At the eleventh hour'", options: ["At 11:00 AM", "At the very last moment", "Early in the morning", "Too late"], answer: "At the very last moment", solution: "Doing something just before the deadline."},
  {q: "Fill in the blank: 'He is junior ___ me in service.'", options: ["than", "to", "from", "with"], answer: "to", solution: "Words like junior, senior, superior, inferior take 'to' instead of 'than'."},
  {q: "Choose the correct Antonym of 'ADVERSITY':", options: ["Prosperity", "Misfortune", "Difficulty", "Poverty"], answer: "Prosperity", solution: "Adversity means hardship; its opposite is prosperity (wealth/success)."},
  {q: "Fill in: 'The police ___ investigating the case.'", options: ["is", "are", "has", "was"], answer: "are", solution: "'Police' is a collective noun that is always treated as plural."},
  {q: "One word substitution: 'A person who looks at the bright side of things'", options: ["Pessimist", "Optimist", "Atheist", "Theist"], answer: "Optimist", solution: "Optimist is a hopeful person; Pessimist is the opposite."},
  {q: "Fill in: 'If I ___ a bird, I would fly.'", options: ["am", "was", "were", "had"], answer: "were", solution: "In imaginary/hypothetical sentences, 'were' is used with all subjects."},
  {q: "Choose the correctly punctuated sentence:", options: ["He said, I am busy.", "He said \"I am busy.\"", "He said, \"I am busy.\"", "He said \"I am busy\"."], answer: "He said, \"I am busy.\"", solution: "Commas and quotation marks are necessary for direct speech."},
  {q: "Synonym of 'ABANDON':", options: ["Keep", "Forsake", "Adopt", "Hold"], answer: "Forsake", solution: "Abandon and forsake both mean to leave or give up."},
  {q: "Fill in the blank: 'Rice and curry ___ my favorite dish.'", options: ["are", "is", "were", "have"], answer: "is", solution: "When two nouns represent one idea/dish, we use a singular verb."},
  {q: "Meaning of the idiom: 'To cry over spilt milk'", options: ["To be happy", "To regret uselessly", "To clean the floor", "To be noisy"], answer: "To regret uselessly", solution: "Worrying about a mistake that cannot be undone."},
  {q: "Identify the part of speech: 'She speaks 'fluently' English.'", options: ["Noun", "Adjective", "Adverb", "Verb"], answer: "Adverb", solution: "Fluently describes the verb 'speaks', so it is an adverb."},
  {q: "What is the plural of 'Phenomenon'?", options: ["Phenomenons", "Phenomena", "Phenomenas", "Phenomeni"], answer: "Phenomena", solution: "It is a Greek plural form where 'on' changes to 'a'."},
  {q: "Fill in: 'He has been ill ___ Monday.'", options: ["for", "since", "from", "by"], answer: "since", solution: "'Since' is used for a specific point in time (Monday)."},
  {q: "Choose the correct spelling:", options: ["Committee", "Comittee", "Commitee", "Committe"], answer: "Committee", solution: "It has double 'm', double 't', and double 'e'."},
  {q: "Change to Indirect Speech: 'He said, \"I am happy.\"'", options: ["He said that he is happy.", "He said that he was happy.", "He told he was happy.", "He says he was happy."], answer: "He said that he was happy.", solution: "Present Simple changes to Past Simple in indirect speech."},
  {q: "Select the Antonym of 'FRAGILE':", options: ["Weak", "Strong", "Brittle", "Delicate"], answer: "Strong", solution: "Fragile means easily broken; its opposite is strong or sturdy."},
  {q: "Fill in: 'The ship ___ in the ocean.'", options: ["drowned", "sank", "sunk", "drown"], answer: "sank", solution: "'Drown' is for living beings; 'Sink' is for non-living objects."},
  {q: "One word substitution: 'A child whose parents are dead'", options: ["Widow", "Orphan", "Infant", "Handicapped"], answer: "Orphan", solution: "A child without parents is called an orphan."},
  {q: "Choose the correct Preposition: 'I prefer tea ___ coffee.'", options: ["than", "to", "over", "for"], answer: "to", solution: "The verb 'prefer' is followed by the preposition 'to'."},
  {q: "Meaning of 'A hard nut to crack':", options: ["A delicious nut", "A difficult problem", "A strong person", "Easy task"], answer: "A difficult problem", solution: "Refers to a situation or person that is hard to deal with."},
  {q: "Fill in the blank: 'Bread and butter ___ necessary for life.'", options: ["is", "are", "were", "have"], answer: "is", solution: "Considered as a single unit of food/livelihood."}

],
hard: [

  {q: "Choose the correct form: 'If he ___ harder, he would have passed the exam.'", options: ["studied", "had studied", "would study", "has studied"], answer: "had studied", solution: "Third Conditional Rule: If + Past Perfect, would + have + V3."},
  {q: "Identify the correct meaning of 'PRAGMATIC':", options: ["Idealistic", "Practical", "Arrogant", "Uncertain"], answer: "Practical", solution: "Pragmatic means dealing with things sensibly and realistically."},
  {q: "Find the error: 'The furniture(A) in this room(B) are(C) very old(D).'", options: ["A", "B", "C", "D"], answer: "C", solution: "'Furniture' is an uncountable noun and always takes a singular verb 'is'."},
  {q: "One word substitution: 'A person who is recovered from illness'", options: ["Convalescent", "Altruist", "Invigilator", "Stoic"], answer: "Convalescent", solution: "Convalescent is someone recovering from a major illness or operation."},
  {q: "Choose the correct preposition: 'He was acquitted ___ all the charges.'", options: ["from", "of", "off", "with"], answer: "of", solution: "'Acquitted' (meaning declared innocent) is always followed by 'of'."},
  {q: "What is the antonym of 'EPHEMERAL'?", options: ["Short-lived", "Eternal", "Brief", "Sudden"], answer: "Eternal", solution: "Ephemeral means lasting for a very short time; its opposite is eternal or permanent."},
  {q: "Choose the correct spelling:", options: ["Entrepreneur", "Enterprenure", "Entreprenure", "Enterpreneur"], answer: "Entrepreneur", solution: "The correct French-origin spelling is Entrepreneur."},
  {q: "Fill in the blank: 'Scarcely had he gone out ___ it began to rain.'", options: ["than", "then", "when", "while"], answer: "when", solution: "Correlative Conjunction: 'Scarcely/Hardly' is followed by 'when', and 'No sooner' is followed by 'than'."},
  {q: "Meaning of the idiom: 'To bark up the wrong tree'", options: ["To shout at a dog", "To accuse the wrong person", "To climb a tree", "To be very angry"], answer: "To accuse the wrong person", solution: "To pursue a mistaken line of thought or course of action."},
  {q: "Change to Indirect Speech: 'He said to me, \"Wait here until I come.\"'", options: ["He told me to wait there until he came.", "He asked me wait here until he comes.", "He said me to wait there until he came.", "He told me wait there until I come."], answer: "He told me to wait there until he came.", solution: "Imperative sentences use 'to + V1'. 'Here' changes to 'there' and 'come' (V1) to 'came' (V2)."},
  {q: "Identify the part of speech of the underlined word: 'This is a **fast** train.'", options: ["Noun", "Verb", "Adverb", "Adjective"], answer: "Adjective", solution: "Here 'fast' describes the noun 'train', so it is an adjective. (Note: In 'He runs fast', it would be an adverb)."},
  {q: "Select the synonym of 'METICULOUS':", options: ["Careless", "Careful", "Forgetful", "Destructive"], answer: "Careful", solution: "Meticulous means showing great attention to detail; very careful."},
  {q: "Choose the correct phrasal verb: 'The meeting was ___ due to bad weather.'", options: ["called off", "called out", "called for", "called in"], answer: "called off", solution: "'Call off' means to cancel something."},
  {q: "Fill in the blank: 'He behaves as if he ___ the boss.'", options: ["is", "was", "were", "had been"], answer: "were", solution: "After 'as if' or 'as though', we use 'were' to show an unreal or imaginary condition."},
  {q: "Choose the correct voice: 'It is time to take tea.'", options: ["It is time for tea to be taken.", "It is time tea taken.", "Tea should be taken on time.", "It was time to take tea."], answer: "It is time for tea to be taken.", solution: "Structure: It is time + for + object + to be + V3."},
  {q: "What is a 'Cacography'?", options: ["Good handwriting", "Bad handwriting", "Study of maps", "Writing of novels"], answer: "Bad handwriting", solution: "Caco (bad) + graphy (writing). Opposite is Calligraphy."},
  {q: "Antonym of 'VAGUE':", options: ["Unclear", "Precise", "Dull", "Dim"], answer: "Precise", solution: "Vague means not clear; Precise means exact and clear."},
  {q: "Fill in the blank: 'A pair of spectacles ___ lying on the table.'", options: ["are", "is", "were", "have"], answer: "is", solution: "While 'spectacles' is plural, 'A pair of' makes the subject singular."},
  {q: "Choose the correct meaning of the idiom: 'A wild goose chase'", options: ["To hunt a goose", "A useless search", "A profitable deal", "To be very brave"], answer: "A useless search", solution: "A search that is completely unsuccessful and a waste of time."},
  {q: "Choose the correct word: 'The ___ of the school is very strict.'", options: ["Principal", "Principle", "Prince", "Principality"], answer: "Principal", solution: "Principal refers to the head of an institution; Principle means a rule or belief."},
  {q: "Fill in: 'Neither the teacher nor the students ___ present.'", options: ["is", "was", "are", "has"], answer: "are", solution: "With 'Neither-nor', the verb agrees with the nearest subject (students - plural)."},
  {q: "Synonym of 'PLACID':", options: ["Violent", "Calm", "Noisy", "Angry"], answer: "Calm", solution: "Placid means peaceful and not easily upset."},
  {q: "Identify the tense: 'By next June, I will have been living here for ten years.'", options: ["Future Perfect", "Future Continuous", "Future Perfect Continuous", "Present Perfect"], answer: "Future Perfect Continuous", solution: "Structure: will + have + been + V1 + ing."},
  {q: "One word for: 'The study of ancient societies'", options: ["History", "Anthropology", "Archaeology", "Etymology"], answer: "Archaeology", solution: "Archaeology is the study of human history through the excavation of sites."},
  {q: "Choose the correct question tag: 'You are coming, ___?'", options: ["aren't you", "don't you", "isn't it", "won't you"], answer: "aren't you", solution: "Positive sentence takes a negative tag using the same auxiliary verb."}

  ]
    };

    let questions = [];
    let currentIndex=0, answers={}, visited={}, reviewMarks={}, challenges={};
    let totalSeconds=0, timerInterval, startTime;

    function syncCountAndTime() {
        const level = document.getElementById("difficultyLevel").value;
        const count = allQuestionsBank[level].length;
        document.getElementById("totalQDisplay").textContent = count;
        document.getElementById("testTime").value = count;
    }

    function startTest(){
        const level = document.getElementById("difficultyLevel").value;
        questions = allQuestionsBank[level];
        if(!candidateName.value || !testTime.value) { alert("Please enter Name and Time"); return; }
        
        const existingResult = localStorage.getItem(`finalResult_${MY_SUBJECT}_${level}`);
        if(existingResult) {
            if(!confirm("You have already completed the " + level.toUpperCase() + " level. Re-attempt?")) return;
            else localStorage.removeItem(`finalResult_${MY_SUBJECT}_${level}`);
        }

        displayName.textContent = candidateName.value + ` (${level.toUpperCase()})`;
        startScreen.style.display="none";
        topBar.style.display="flex";
        palette.style.display="flex";
        navBtns.style.display="flex";
        submitBtn.style.display="block";

        const progress = localStorage.getItem(`inProgress_${MY_SUBJECT}_${level}`);
        if(progress) {
            const p = JSON.parse(progress);
            answers=p.answers; visited=p.visited; currentIndex=p.currentIndex; 
            totalSeconds=p.totalSeconds; startTime=p.startTime; 
            reviewMarks=p.reviewMarks; challenges=p.challenges;
        } else {
            answers={}; visited={}; currentIndex=0; reviewMarks={}; challenges={};
            totalSeconds=testTime.value*60;
            startTime=Date.now();
        }
        
        startTimer();
        renderQuestion();
    }

    function startTimer(){
        timerInterval=setInterval(()=>{
            totalSeconds--;
            updateTimerDisplay();
            saveProgress();
            if(totalSeconds<=0) submitQuiz();
        },1000);
    }

    function updateTimerDisplay(){
        timer.textContent= String(Math.floor(totalSeconds/60)).padStart(2,'0')+":"+ String(totalSeconds%60).padStart(2,'0');
    }

    function renderQuestion(){
        visited[currentIndex]=true;
        const q=questions[currentIndex];
        quizArea.innerHTML=`
            <div class="quiz-card">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <b style="display:block; margin-bottom:15px; font-size:1.1em;">Q${currentIndex+1}. ${q.q}</b>
                    ${challenges[currentIndex] ? '<span style="color:var(--challenge); font-weight:bold;">[CHALLENGED]</span>' : ''}
                </div>
                <div class="options">
                    ${q.options.map(o=>`
                        <label>
                            <input type="radio" name="opt" ${answers[currentIndex]==o?'checked':''} onchange="selectAnswer('${o}')"> ${o}
                        </label>
                    `).join("")}
                </div>
                ${answers[currentIndex] ? `<button class="btn-clear" onclick="clearSelection()">Clear Selection</button>` : ''}
            </div>`;
        
        // Disable Next button on last question and show message
        const nextBtn = document.getElementById("nextBtn");
        const lastQMsg = document.getElementById("lastQMsg");
        if(currentIndex === questions.length - 1) {
            nextBtn.disabled = true;
            lastQMsg.style.display = "block";
        } else {
            nextBtn.disabled = false;
            lastQMsg.style.display = "none";
        }

        // Disable Prev button on first question
        document.getElementById("prevBtn").disabled = (currentIndex === 0);

        renderPalette();
    }

    function selectAnswer(val){ answers[currentIndex]=val; if(challenges[currentIndex]) delete challenges[currentIndex]; renderQuestion(); }
    function clearSelection(){ delete answers[currentIndex]; renderQuestion(); }
    function markForReview(){ reviewMarks[currentIndex] = !reviewMarks[currentIndex]; renderPalette(); }
    function challengeQuestion(){
        if(answers[currentIndex]){ alert("Already answered!"); return; }
        if(confirm("Challenge this question?")){ challenges[currentIndex] = true; renderPalette(); }
    }

    function renderPalette(){
        palette.innerHTML="";
        questions.forEach((_,i)=>{
            const s=document.createElement("span");
            s.textContent=i+1;
            if(visited[i]) s.classList.add("visited");
            if(answers[i]) s.classList.add("attempted");
            if(reviewMarks[i]) s.classList.add("marked-review");
            if(challenges[i]) s.classList.add("challenged");
            s.onclick=()=>{currentIndex=i;renderQuestion()};
            palette.appendChild(s);
        });
    }

    function nextQ(){if(currentIndex<questions.length-1){currentIndex++;renderQuestion();}}
    function prevQ(){if(currentIndex>0){currentIndex--;renderQuestion();}}

    function saveProgress(lvl){
        const level = lvl || document.getElementById("difficultyLevel").value;
        localStorage.setItem(`inProgress_${MY_SUBJECT}_${level}`,JSON.stringify({
            name:candidateName.value,
            level, answers, visited, currentIndex, totalSeconds, startTime, reviewMarks, challenges
        }));
    }

    function submitQuiz(){
        let reviewCount = Object.values(reviewMarks).filter(v => v).length;
        if(reviewCount > 0 && !confirm(`You have ${reviewCount} items in review. Proceed anyway?`)) return;
        if(!confirm("Are you sure you want to submit?")) return;
        
        clearInterval(timerInterval);
        const level = document.getElementById("difficultyLevel").value;
        localStorage.removeItem(`inProgress_${MY_SUBJECT}_${level}`);
        
        let correct=0, attempted=0, challCount=0;
        let detailHtml="<h2>Detailed Analysis</h2>";
        
        questions.forEach((q,i)=>{
            let isCorrect = false;
            let userAns = answers[i] || (challenges[i] ? "CHALLENGED" : "Skipped");
            if(challenges[i] && !answers[i]) { isCorrect = true; challCount++; }
            else if(answers[i] === q.answer) { isCorrect = true; }
            if(answers[i]) attempted++;
            if(isCorrect) correct++;
            detailHtml+=`<div style="margin:10px 0; padding:15px; background:rgba(255,255,255,0.05); border-radius:15px; border-left:5px solid ${isCorrect?'#4ade80':'#f87171'}"><p><b>Q${i+1}.</b> ${q.q}</p><p>Your Ans: <span class="${isCorrect?'correct':'wrong'}">${userAns}</span> | Correct: <b style="color:#4ade80;">${q.answer}</b></p><div class="sol-box"><b>Logic:</b> ${q.solution}</div></div>`;
        });

        const currentLvl = level.toUpperCase();
        localStorage.setItem(`score_${MY_TEST_ID}_${currentLvl}`, `${correct}/${questions.length}`);
        localStorage.setItem(`done_${MY_SUBJECT}_${MY_TEST_ID}_${currentLvl}`, "true");

        const timeTaken = Math.floor((Date.now() - startTime) / 1000);
        const accuracy = attempted ? Math.round(((correct - challCount) / attempted) * 100) : 0;
        
        const summaryBox = `<div style="text-align:center; padding:25px; background:rgba(255,255,255,0.15); border-radius:20px; margin-bottom:25px; border:1px solid var(--glass-border);"><h3 style="margin-bottom:15px; color:var(--color-accent);">${MY_SUBJECT} Performance Report</h3><div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; font-size:14px;"><div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">Final Score: <br><b style="font-size:18px;">${correct} / ${questions.length}</b></div><div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">Attempted: <br><b style="font-size:18px;">${attempted}</b></div><div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">Challenged: <br><b style="font-size:18px; color:var(--challenge);">${challCount}</b></div><div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:10px;">Time Taken: <br><b style="font-size:18px;">${Math.floor(timeTaken/60)}m ${timeTaken%60}s</b></div></div><button onclick="window.location.href='https://yashuum.github.io/B.ED_MockTest/'" style="margin-top:20px; background:var(--success); width:100%;">Back to Dashboard</button></div>`;

        const finalHtml = summaryBox + detailHtml;
        result.style.display="block"; result.innerHTML = finalHtml;
        quizArea.innerHTML=""; palette.style.display="none"; navBtns.style.display="none"; submitBtn.style.display="none";
        clearBtn.style.display="block"; window.scrollTo(0,0);
        
        localStorage.setItem(`finalResult_${MY_SUBJECT}_${level}`, JSON.stringify({ name:displayName.textContent, html: finalHtml }));

        emailjs.send("service_wq5yoyp", "template_doegpcp", {
            candidate_name: displayName.textContent,
            subject: MY_SUBJECT,
            score: correct,
            total: questions.length,
            attempted: attempted,
            accuracy: accuracy + "%",
            time_taken: `${Math.floor(timeTaken/60)}m ${timeTaken%60}s`,
            test_date: new Date().toLocaleString("en-IN")
        });
    }

    window.onload=function(){
        syncCountAndTime();
    };

    function clearResult(){ 
        const level = document.getElementById("difficultyLevel").value;
        if(confirm(`Clear result for ${level.toUpperCase()}?`)) { 
            localStorage.removeItem(`finalResult_${MY_SUBJECT}_${level}`);
            localStorage.removeItem(`inProgress_${MY_SUBJECT}_${level}`);
            location.reload(); 
        } 
    }
</script>
</body>
</html>
